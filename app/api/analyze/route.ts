import { generateObject } from "ai";
import { model } from "@/lib/azure";
import { z } from "zod";

export async function POST(req: Request) {
  const { message } = await req.json();

  console.log("\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ");
  console.log("๐ [ANALYZE API] Request received");
  console.log("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ");
  console.log("Message:", message.substring(0, 200) + (message.length > 200 ? "..." : ""));
  console.log("Message length:", message.length);
  console.log("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ");

  try {
    const result = await generateObject({
      model,
      schema: z.object({
        riskScore: z.number().min(0).max(100).describe("ุฏุฑุฌุฉ ุงูุฎุทุฑ ูู 0 ุฅูู 100"),
        verdict: z.string().describe("ุญูู ูุฎุชุตุฑ ุนูู ุงูุฑุณุงูุฉ"),
        redFlags: z.array(z.string()).describe("ูุงุฆูุฉ ุงูุนูุงูุงุช ุงูุชุญุฐูุฑูุฉ ุงููุฑุตูุฏุฉ"),
        explanation: z.string().describe("ุดุฑุญ ูุจุณุท ูุฃุณุจุงุจ ุงูุชูููู"),
        recommendation: z.string().describe("ูุง ูุฌุจ ุนูู ุงููุณุชุฎุฏู ูุนูู"),
      }),
      prompt: `ุฃูุช ุฎุจูุฑ ุฃูู ุณูุจุฑุงูู ุชููุณู ูุชุฎุตุต ูู ุชุญููู ุงูุงุญุชูุงู ุงูุฑููู. ุญูู ุงูุฑุณุงูุฉ ุงูุชุงููุฉ:

"${message}"

ุงููุทููุจ:
1. ุฃุนุทู ุฏุฑุฌุฉ ุฎุทุฑ ูู 0 (ุขูู ุชูุงูุงู) ุฅูู 100 (ุงุญุชูุงู ูุคูุฏ)
2. ุงุฐูุฑ ุงูุนูุงูุงุช ุงูุชุญุฐูุฑูุฉ
3. ุงุดุฑุญ ููุงุฐุง ูุฐู ุงูุฑุณุงูุฉ ูุดุจููุฉ ุฃู ุขููุฉ
4. ูุฏู ูุตูุญุฉ ูุงุถุญุฉ ูููุณุชุฎุฏู

ููุงุนุฏ ุงูุชุญููู:
- ุฑูุงุจุท ุจูุทุงูุงุช ุบุฑูุจุฉ (.xyz, .tk, .ml) = ุฎุทุฑ ุนุงูู
- ุทูุจ ูุนูููุงุช ุดุฎุตูุฉ (ูููุฉุ ุญุณุงุจ ุจููู) = ุฎุทุฑ ุนุงูู
- ูุบุฉ ุงุณุชุนุฌุงููุฉ (ููุฑุงูุ ุฎูุงู 24 ุณุงุนุฉ) = ูุคุดุฑ ุงุญุชูุงู
- ุงูุชุญุงู ุตูุฉ ูุคุณุณุฉ ุชููุณูุฉ (ุจุฑูุฏุ ุจููุ STEG) = ุชุญูู ูู ุงููุตุฏุฑ
- ุนุฑูุถ ูุงููุฉ ูุบุฑูุฉ = ุงุญุชูุงู ูู ุงูุบุงูุจ

ุงุณุชุฎุฏู ูุบุฉ ุนุฑุจูุฉ ุจุณูุทุฉ. ูู ูุจุงุดุฑุงู ููุงุถุญุงู.`,
    });

    console.log("\nโ [ANALYZE API] AI Response:");
    console.log(JSON.stringify(result.object, null, 2));
    console.log("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n");

    return Response.json(result.object);
  } catch (error) {
    console.error("\nโ [ANALYZE API] Error:", error);
    console.log("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n");
    return Response.json(
      { error: "AI generation failed", details: String(error) },
      { status: 500 }
    );
  }
}
