import { generateObject } from "ai";
import { model } from "@/lib/azure";
import { z } from "zod";

export async function POST(req: Request) {
  const { message, contextUrl, mode } = await req.json();

  console.log("\nโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ");
  console.log(`๐ [ANALYZE API] ${mode === "extension" ? "Extension" : "Web"} Request received`);
  console.log("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ");
  console.log("Message:", message.substring(0, 200) + (message.length > 200 ? "..." : ""));
  if (contextUrl) console.log("Context URL:", contextUrl);
  console.log("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ");

  try {
    const isExtension = mode === "extension";
    
    const result = await generateObject({
      model,
      schema: z.object({
        riskScore: z.number().min(0).max(100).describe("ุฏุฑุฌุฉ ุงูุฎุทุฑ ูู 0 ุฅูู 100"),
        verdict: z.string().describe("ุญูู ูุฎุชุตุฑ ุนูู ุงูุฑุณุงูุฉ"),
        redFlags: z.array(z.string()).describe("ูุงุฆูุฉ ุงูุนูุงูุงุช ุงูุชุญุฐูุฑูุฉ ุงููุฑุตูุฏุฉ"),
        explanation: z.string().describe("ุดุฑุญ ูุจุณุท ูุฃุณุจุงุจ ุงูุชูููู"),
        recommendation: z.string().describe("ูุง ูุฌุจ ุนูู ุงููุณุชุฎุฏู ูุนูู"),
        isUrgent: z.boolean().describe("ูู ุชุชุทูุจ ุงูุฑุณุงูุฉ ุฅุฌุฑุงุกู ููุฑููุงุ"),
      }),
      prompt: `ุฃูุช ุฎุจูุฑ ุฃูู ุณูุจุฑุงูู ุชููุณู ูุชุฎุตุต ูู ุชุญููู ุงูุงุญุชูุงู ุงูุฑููู ูุงูููุงูุฉ ููู. 
${isExtension ? "ูุชู ุงุณุชุฏุนุงุคู ูู ุฅุถุงูุฉ ูุชุตูุญ ูุชุญููู ูุต ูุงู ุงููุณุชุฎุฏู ุจุชุญุฏูุฏู." : "ุชุญูู ุงูุขู ุฑุณุงูุฉ ูุดุจููุฉ ูุงุฑุฏุฉ."}

ุงููุต ููุชุญููู:
"${message}"
${contextUrl ? `ุฑุงุจุท ุงููููุน ุงูุฐู ูุฌุฏ ููู ุงููุต: ${contextUrl}` : ""}

ุงููุทููุจ:
1. ุงุฐูุฑ ุงูุนูุงูุงุช ุงูุชุญุฐูุฑูุฉ (ูุซู: ุฑูุงุจุท ูุดุจููุฉุ ุงูุชุญุงู ุตูุฉ ุจุฑูุฏ ุชููุณ ุฃู ุจูู ุชููุณูุ ูุบุฉ ุงุณุชุนุฌุงููุฉ).
2. ุงุดุฑุญ ููุงุฐุง ูุฐุง ุงููุต ูุดุจูู ุฃู ุขููุ ูุน ุงูุชุฑููุฒ ุนูู ุงูุฃุณุงููุจ ุงููุณุชุฎุฏูุฉ ูู ุชููุณ.
3. ูุฏู ูุตูุญุฉ ูุงุถุญุฉ ููุฎุชุตุฑุฉ ูููุณุชุฎุฏู.
4. ุฅุฐุง ูุงู ุงููุต ูุฌุฑุฏ ุฌุฒุก ุตุบูุฑุ ุญุงูู ุงุณุชูุชุงุฌ ุงูุณูุงู ุจูุงุกู ุนูู ุงููููุงุช ุงูููุชุงุญูุฉ ุงูุชููุณูุฉ (ูุซูุงู: "ุญุณุงุจู ูุฌูุฏ"ุ "ูุตูู ุทุฑุฏ"ุ "ุฏููุงุฑ").

${isExtension ? "ููุงุญุธุฉ: ุงุฌุนู ุงูุฑุฏ ูุฎุชุตุฑูุง ุฌุฏูุง ูููุงุณุจ ุนุฑุถ ุฅุถุงูุฉ ุงููุชุตูุญ." : ""}
ุงุณุชุฎุฏู ูุบุฉ ุนุฑุจูุฉ ุจุณูุทุฉ ูุชููุณูุฉ ุจูุถุงุก. ูู ูุจุงุดุฑุงู.`,
    });

    console.log("\nโ [ANALYZE API] AI Response:");
    console.log(JSON.stringify(result.object, null, 2));
    console.log("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n");

    return Response.json(result.object);
  } catch (error) {
    console.error("\nโ [ANALYZE API] Error:", error);
    console.log("โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ\n");
    return Response.json(
      { error: "AI generation failed", details: String(error) },
      { status: 500 }
    );
  }
}
